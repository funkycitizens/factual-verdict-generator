<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style>
canvas { border: 1px solid black; }
</style>
<style></style></head><body>

width <input name="width" value="960"><br>
height <input name="height" value="960"><br>
Declarație: <select id="decl">
  <option value="#E6383F">Fals</option>
  <option value="#F08283">Parțial fals</option>
  <option value="#373737">Neutru</option>
  <option value="#9FD6D0">Parțial adv.</option>
  <option value="#27B198">Adevărat</option>
</select><br>

<input type="file"><br>

text <textarea name="text"></textarea><br>
filename <input name="filename" value="factual.png"><br>
<button id="render">render</button><br><br>

<canvas id="cnv" width="32" height="32"></canvas><br><br>
<a id="download" download="Canvas.png" href="#">Download</a>

<script src="https://unpkg.com/jquery"></script>
<script>

function render() {
  var width = +$('[name=width]').val();
  var height = +$('[name=height]').val();
  var filename = $('[name=filename]').val();
  var decl = $('#decl').val();
  var facepic = document.querySelector('input[type=file]').files[0];
  var reader = new FileReader();

  var canvas = $("#cnv")[0];
  $(canvas).attr({width: width, height: height});
  var ctx = canvas.getContext("2d");

  ctx.clearRect(0, 0, width, height);

  function r(ctx, x, y, w, h, c) {
    ctx.beginPath();
    ctx.rect(x, y, w, h);
    ctx.strokeStyle = c;
    ctx.stroke();
  }
  r(ctx, 0, 0, 32, 32, "black");
  r(ctx, 4, 4, 16, 16, "red");
  r(ctx, 8, 8, 16, 16, "green");
  r(ctx, 12, 12, 16, 16, "blue");

  ctx.fillStyle = decl;
  ctx.fillRect(0, 0, width, width*12/100);
  ctx.fillRect(0, height-30, width, 30);
  ctx.fillRect(width-420, height-90, width, 90);
  ctx.moveTo(width-420, height-90); 
  ctx.lineTo(width-460, height-30);
  ctx.lineTo(width-420, height-30);
  ctx.fill();

  var paleta = new Image();
  paleta.addEventListener('load', function() {
    ctx.drawImage(paleta, 780, 57) }, false);
  paleta.src = 'paleta.png';

  var img=new Image();
  img.onload = drawBall;
  img.src=reader.readAsDataURL(facepic);

  function drawBall(facepic) {
    c.width = this.width;
    c.height = this.height;
  
    // default gCO is source-over
    ctx.drawImage(img,-250,-200, img.width*.7, img.height*.7);
    // now we change the gCO
    ctx.globalCompositeOperation='destination-in';
    ctx.beginPath();
    ctx.arc(75, 75, 50, 0, Math.PI*2);
    ctx.fillStyle = "#0095DD";
    ctx.fill();
    // reset to default
    ctx.globalCompositeOperation='source-over';
    // closePath is useless here
    //ctx.closePath();
  }

  var dt = canvas.toDataURL('image/png');
  dt = dt.replace(/^data:image\/[^;]*/, 'data:application/octet-stream');
  dt = dt.replace(/^data:application\/octet-stream/, 'data:application/octet-stream;headers=Content-Disposition%3A%20attachment%3B%20filename=' + $('#download').attr('download'));
  $('#download').attr('href', dt);
  $('#download').attr('download', filename);
}

$('#render').click(render);
</script>
</body></html>
